<div class="controls">
    <input type="text" id="nk" placeholder="NICK" style="width:80px">
    <input type="password" id="key" placeholder="SECRET_KEY" style="width:100px">
    <input type="text" id="ms" placeholder="ENCRYPTED_DATA_INPUT..." style="flex-grow:1" autocomplete="off">
    <button id="ex">EXEC</button>
</div>

<script>
    // Функция шифрования/дешифрования (XOR по ключу)
    function crypt(text, key) {
        if (!key) return text; // Если ключа нет, не шифруем
        let output = "";
        for (let i = 0; i < text.length; i++) {
            // Применяем XOR к коду символа
            let charCode = text.charCodeAt(i) ^ key.charCodeAt(i % key.length);
            output += String.fromCharCode(charCode);
        }
        return output;
    }

    async function sync() {
        try {
            const r = await fetch(API);
            const t = await r.text();
            const secret = document.getElementById('key').value;
            
            // Разделяем сообщения и пробуем расшифровать каждое
            let lines = t.split('\n');
            let decodedOutput = "";
            
            lines.forEach(line => {
                if (!line.includes(": ")) {
                    decodedOutput += line + "\n";
                    return;
                }
                let [user, msg] = line.split(": ");
                try {
                    // Пытаемся расшифровать только сообщение
                    let decrypted = crypt(atob(msg), secret); // Используем Base64 для передачи
                    decodedOutput += `${user}: ${decrypted}\n`;
                } catch(e) {
                    // Если расшифровать нельзя (не Base64), игнорируем или выводим как есть
                    decodedOutput += line + "\n";
                }
            });

            if (decodedOutput !== cache) {
                chat.innerText = decodedOutput;
                chat.scrollTop = chat.scrollHeight;
                cache = decodedOutput;
            }
        } catch (e) {}
    }

    async function send() {
        const n = document.getElementById('nk').value || "ANON";
        const secret = document.getElementById('key').value;
        const rawMsg = document.getElementById('ms').value;
        if (!rawMsg) return;

        // Шифруем перед отправкой и кодируем в Base64 для безопасной передачи
        const encryptedMsg = btoa(crypt(rawMsg, secret));
        
        try {
            await fetch(API, { method: 'POST', body: `${n}: ${encryptedMsg}` });
            document.getElementById('ms').value = '';
            sync();
        } catch (e) {}
    }
</script>
