<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>胡耶塔 // CHAT</title>
    <style>
        body { background: #000; color: #00ff41; font-family: monospace; display: flex; flex-direction: column; height: 100vh; margin: 0; }
        #chat { flex-grow: 1; padding: 15px; overflow-y: auto; white-space: pre-wrap; border-bottom: 1px solid #00ff41; }
        .controls { padding: 10px; display: flex; gap: 5px; }
        input { background: #111; border: 1px solid #00ff41; color: #00ff41; padding: 8px; }
        #nk { width: 70px; }
        #key { width: 100px; border-color: #ff0055; }
        #ms { flex-grow: 1; }
        button { background: #00ff41; color: #000; border: none; padding: 8px 15px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>
    <div id="chat"></div>
    <div class="controls">
        <input type="text" id="nk" placeholder="НИК">
        <input type="password" id="key" placeholder="КЛЮЧ">
        <input type="text" id="ms" placeholder="СООБЩЕНИЕ..." autocomplete="off">
        <button id="ex">ОТПРАВИТЬ</button>
    </div>

    <script>
        const chat = document.getElementById('chat');
        // ЗАМЕНИ НА СВОЮ ССЫЛКУ ОТ RENDER (например https://my-chat.onrender.com/api)
        const RENDER_URL = 'https://public-chat-4p8s.onrender.com/api'; 
        const API = window.location.protocol === 'file:' ? RENDER_URL : '/api';

        let cache = [];

        // Функция шифрования/дешифрования (XOR + UTF-8)
        function xor(text, key) {
            if (!key) return text;
            const t = new TextEncoder().encode(text);
            const k = new TextEncoder().encode(key);
            return t.map((b, i) => b ^ k[i % k.length]);
        }

        async function sync() {
            try {
                const r = await fetch(API);
                const t = await r.text();
                const lines = t.split('\n').filter(l => l.trim());
                const key = document.getElementById('key').value;

                let output = "";
                lines.forEach(line => {
                    if (line.includes(": ")) {
                        const [user, b64] = [line.split(": ")[0], line.split(": ").slice(1).join(": ")];
                        try {
                            const bytes = new Uint8Array(atob(b64).split("").map(c => c.charCodeAt(0)));
                            const decrypted = new TextDecoder().decode(xor(String.fromCharCode(...bytes), key));
                            output += `${user}: ${decrypted}\n`;
                        } catch(e) { output += line + "\n"; }
                    } else { output += line + "\n"; }
                });

                if (output !== chat.innerText) {
                    chat.innerText = output;
                    chat.scrollTop = chat.scrollHeight;
                }
            } catch(e) {}
        }

        async function send() {
            const n = document.getElementById('nk').value || "ANON";
            const m = document.getElementById('ms').value;
            const k = document.getElementById('key').value;
            if (!m) return;

            const encrypted = xor(m, k);
            const b64 = btoa(String.fromCharCode(...encrypted));
            
            await fetch(API, { method: 'POST', body: `${n}: ${b64}` });
            document.getElementById('ms').value = '';
            sync();
        }

        document.getElementById('ex').onclick = send;
        document.getElementById('ms').onkeypress = (e) => e.key === 'Enter' && send();
        setInterval(sync, 2000);
        sync();
    </script>
</body>
</html>
