<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANALYZER // SYSTEM_DEBUG</title>
    <style>
        :root { --n: #00ff41; --b: #050505; --r: #ff0055; --w: #ffffff; --o: #0088ff; }
        * { box-sizing: border-box; }
        
        body { 
            background: var(--b); color: var(--n); font-family: 'Consolas', 'Courier New', monospace; 
            margin: 0; padding: 20px; text-shadow: 0 0 5px rgba(0,255,65,0.5);
        }

        /* Стиль шапки управления */
        header { 
            border: 1px solid var(--n); padding: 15px; margin-bottom: 20px; 
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,255,65,0.05); box-shadow: 0 0 15px rgba(0,255,65,0.1);
        }

        .stats-group { display: flex; gap: 20px; align-items: center; }
        .counter-badge { background: var(--n); color: #000; padding: 5px 10px; font-weight: bold; border-radius: 3px; }

        /* Таблица анализа */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
        th { 
            border: 1px solid var(--n); padding: 12px; text-align: left; 
            background: rgba(0,255,65,0.2); font-size: 13px; text-transform: uppercase;
        }
        td { border: 1px solid #222; padding: 12px; word-break: break-all; vertical-align: top; font-size: 13px; }

        /* Статусы пакетов */
        .status-secure { color: var(--r); font-weight: bold; }
        .status-open { color: var(--o); font-weight: bold; }
        .raw-data { color: #555; font-size: 11px; font-family: 'Courier New', serif; }
        .output-text { color: var(--w); font-weight: bold; background: rgba(255,255,255,0.05); padding: 5px; display: block; border-left: 2px solid var(--n); }

        /* Кнопки */
        #purge-btn { 
            background: none; border: 1px solid var(--r); color: var(--r); 
            padding: 10px 20px; cursor: pointer; font-family: inherit; font-weight: bold;
            transition: 0.3s;
        }
        #purge-btn:hover { background: var(--r); color: #000; box-shadow: 0 0 10px var(--r); }

        .blink { animation: blinker 1.5s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</head>
<body>

    <header>
        <div class="stats-group">
            <div><strong>[ PACKET_ANALYZER_V3.5 ]</strong></div>
            <div class="counter-badge">CAPTURED: <span id="count">0</span></div>
            <div style="font-size: 10px;" class="blink">● LISTENING_NETWORK...</div>
        </div>
        <button id="purge-btn" onclick="wipeServer()">WIPE_STORAGE</button>
    </header>

    <table id="analyzer-table">
        <thead>
            <tr>
                <th style="width: 120px;">SOURCE_ID</th>
                <th style="width: 25%;">RAW_PAYLOAD (B64)</th>
                <th style="width: 150px;">PROTOCOL / KEY</th>
                <th>DECODED_CONTENT</th>
            </tr>
        </thead>
        <tbody id="logs">
            </tbody>
    </table>

<script>
    const API = '/api';
    const logsBody = document.getElementById('logs');
    const countEl = document.getElementById('count');

    // Функция XOR (такая же как в основном чате)
    function crypt(t, k) {
        if (!k) return t;
        const te = new TextEncoder().encode(t);
        const ke = new TextEncoder().encode(k);
        return String.fromCharCode(...te.map((b, i) => b ^ ke[i % ke.length]));
    }

    async function wipeServer() {
        if(confirm("DANGER: ВЫ УВЕРЕНЫ, ЧТО ХОТИТЕ УДАЛИТЬ ВСЕ ДАННЫЕ С СЕРВЕРА?")) {
            await fetch(API, { method: 'DELETE' });
            runAnalysis();
        }
    }

    async function runAnalysis() {
        try {
            const r = await fetch(API);
            const rawData = await r.text();
            const lines = rawData.split('\n').filter(l => l.trim());
            
            countEl.innerText = lines.length;
            logsBody.innerHTML = "";

            lines.reverse().forEach(line => { // reverse() чтобы новые были сверху
                if (line.includes(": ")) {
                    let [user, fullPayload] = [line.split(": ")[0], line.split(": ").slice(1).join(": ")];
                    
                    // Разбор пакета на данные и ключ
                    let [cipher, key] = fullPayload.split("::KEY::");
                    
                    let decodedResult = "";
                    let protocolLabel = "";

                    if (key) {
                        // Режим SECURE (был использован ключ)
                        try {
                            let binary = atob(cipher);
                            decodedResult = decodeURIComponent(crypt(binary, key));
                            protocolLabel = `<span class="status-secure">SECURE (${key})</span>`;
                        } catch(e) {
                            decodedResult = "<span style='color:var(--r)'>[DECRYPT_FAILED]</span>";
                            protocolLabel = `<span class="status-secure">ERR_KEY</span>`;
                        }
                    } else {
                        // Режим OPEN (шифрования не было)
                        try {
                            decodedResult = decodeURIComponent(atob(cipher));
                            protocolLabel = `<span class="status-open">OPEN_PROTOCOL</span>`;
                        } catch(e) {
                            decodedResult = cipher; // Если даже не Base64
                            protocolLabel = `<span>UNKNOWN</span>`;
                        }
                    }

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><strong>${user}</strong></td>
                        <td class="raw-data">${cipher}</td>
                        <td>${protocolLabel}</td>
                        <td><span class="output-text">${decodedResult}</span></td>
                    `;
                    logsBody.appendChild(tr);
                }
            });
        } catch(e) {
            console.error("Analysis Error:", e);
        }
    }

    // Живое обновление каждые 3 секунды
    setInterval(runAnalysis, 3000);
    // Первый запуск
    runAnalysis();
</script>
</body>
</html>
